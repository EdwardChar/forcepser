# Changelog

## 0.1beta19 2020-08-26

- exofile / luafile の仕組みが正しく動いていなかったのを修正
- オブジェクトの長さ計算を修正
- 起動時の状態出力を改善

## 0.1beta18 2020-08-24

- 大量のファイル操作が短時間に発生した際に内部バッファが溢れることがあったのを軽減

## 0.1beta17 2020-08-20

- 同梱する asas のバージョンを更新

## 0.1beta16 2020-08-19

- setting.txt の読み込み処理を作り直した
- `[[rule]]` に `filemove` と `deletetext` を書くことで設定を個別に上書きできるようにした

## 0.1beta15 2020-08-17

- カレントディレクトリが exe ファイルのフォルダーではないときに上手く動かなかった問題を修正
- グローバルセクションに `exofile=template.exo` と `luafile=genexo.lua` の設定を追加
  - 絶対パスで書けば外のフォルダーにおいたテンプレートファイルでも読み込めるはず（未テスト）
- グローバルセクションと `[[rule]]` セクションに `padding=0` の設定を追加
  - `padding` の設定を PSDToolKit で使うためには v0.2beta47 以降のバージョンが必要です
  - `*.exo` を生成する際は `__json=~~` というデータを埋め込まないと PSDToolKit が padding が認識できません
- `[[rule]]` セクションの `dir` が見つからなくても警告した上で処理を続行するように変更
- `[[rule]]` の `modifier` で `layer` `filename` `userdata` `exofile` `luafile` を動的に変更可能にした
  - `modifier` から代入すれば `userdata` に任意の型を格納できるようになった
- exe ファイルがあるフォルダーに `tmp` というフォルダーを自動生成するようにした
  - `[[rule]]` の `dir` に `%TEMPDIR%` を含むと `tmp` フォルダーに置換されるようにした
- `[[asas]]` で asas 用の定義を記述できるようにし、かんしくん起動時に連動起動できる機構を追加
- 設定ファイルの記述を簡略化するための変更
  - `[[rule]]` の `dir` のデフォルト値を `%TEMPDIR%` にした
  - `[[rule]]` の `encoding` のデフォルト値を `sjis` にした
- `genexo.lua` で新しく追加された設定値にアクセスできるように `gen` に代わり `gen2` を使えるようにした
  - `gen` を使ったスクリプトも依然として動作しますが、`padding` のような新しい設定値へのアクセス手段がありません。

`genexo.lua` の新しい仕様は以下のようなものです。

```lua
-- 文字エンコーディングは UTF-8 にしてください
local P = {}
-- 関数名が gen2 になり、引数が変わりました
-- 以前の layer と userdata は rule.layer, rule.userdata でアクセスでき、そのほか rule.padding などもあります
function P.gen2(proj, file, text, rule)
  local length = 30
  return tosjis("[exedit]\r\nwidth=1280\r\nheight=720\r\nrate=30\r\nscale=1\r\nlength=" .. length .. "..."), length
end
return P
```

## 0.1beta14 2020-06-25

- プログラムと同じフォルダーに `genexo.lua` を作成することで Lua で直接 `*.exo` の中身を生成できる仕組みを追加
- プログラムと同じフォルダーに `template.exo` を作成することで、カスタマイズされた `*.exo` を作れる仕組みを追加
- `[[rule]]` 内で `userdata = 'abcdef'` のように文字列を割り当てておくと `genexo.lua` で参照できる仕組みを追加

`genexo.lua` を作成する場合は概ね以下のような感じで、`*.exo` の内容になるテキストとカーソルを進めるフレーム数を返してください。

```lua
-- 文字エンコーディングは UTF-8 にしてください
local P = {}
function P.gen(proj, file, text, layer, userdata)
  local length = 30
  return tosjis("[exedit]\r\nwidth=1280\r\nheight=720\r\nrate=30\r\nscale=1\r\nlength=" .. length .. "..."), length
end
return P
```

## 0.1beta13 2020-06-25

- AviUtl のプロジェクトファイルと同じ場所に `*.wav` や `*.txt` を移せる `filemove` オプションを追加(ごちゃまぜドロップス v0.3.13 以降が必須)
- 処理後に不要になったテキストファイルを消す `deletetext` オプションを追加

## 0.1beta12 2019-03-17

- 文字コード UTF-16LE と UTF-16BE に対応
- modifier で外部コマンド実行の仕組みを追加
- 詳細モードで AviUtl 側のプロジェクト情報を出力するようにした
- その他軽微なバグを修正

## 0.1beta11 2018-05-13

- 定義されているルール設定をログに出力するようにした
  - setting.txt の文字コード間違いを視認できる場所を作るための措置です

## 0.1beta10 2018-05-13

- 詳細モードのログを更に詳しくした

## 0.1beta9 2018-04-27

- 数値のパラメーターで小数点を省くと panic していたのを修正
- delta や freshness に 0 を渡すと無効化できるはずが動いていなかったのを修正
  - 設定の省略時はそれぞれ 15 / 5 になり、明示的に 0 を渡すと無効化
- ログを見やすくなるように改善

## 0.1beta8 2018-04-26

- 特定の状況下で更新していないファイルが追加されてしまうバグを修正

## 0.1beta7 2018-04-26

- 更新日時が古いファイルを無視するための freshness オプションを追加
- 起動時に -v オプションを渡すことでより詳細なログを出力できるよう改善

## 0.1beta6 2018-04-18

- ファイルの読み込みに失敗した時にリトライするように改善
- エラー理由をもう少し詳細に出すように改善
- basedir でフォルダー名を集約できるように改善
- 起動したままでの setting.txt の書き換えに対応
- 64bit 版ではなく 32bit 版でリリースするように変更

## 0.1beta5 2018-04-13

- テキスト本文もルール定義に利用できるよう改善
- 投げ込む前にテキストを置換できるように改善
- 複数ファイル検出時に更新日時が古い順に並び替え

## 0.1beta4 2018-04-12

- 複数のフォルダーの監視に対応

## 0.1beta3 2018-04-12

- setting.txt での BOM を許容

## 0.1beta2 2018-04-12

- 同じファイルを連続で送らないように抑制

## 0.1beta 2018-04-12

- 初版
